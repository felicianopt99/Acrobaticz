# Cloud Storage Feature - Data Storage Analysis

## Overview
The AV-Rentals cloud feature uses a **hybrid storage model** combining:
1. **File System Storage** - Actual file content on an external disk
2. **PostgreSQL Database** - Metadata and references to files

---

## 1. File System Storage

### Storage Location
**Primary Path:** `/mnt/backup_drive/av-rentals/cloud-storage`

**Configuration:**
- Default: `/mnt/backup_drive/av-rentals/cloud-storage`
- Can be overridden via: `EXTERNAL_STORAGE_PATH` environment variable
- Temporary storage: `/mnt/backup_drive/av-rentals/cloud-storage/temp`
- Can be overridden via: `EXTERNAL_STORAGE_TEMP` environment variable

**File:** [src/lib/storage.ts](src/lib/storage.ts#L5-L6)

### Directory Structure
```
/mnt/backup_drive/av-rentals/cloud-storage/
├── {userId}/
│   ├── files/
│   │   ├── {filename}
│   │   ├── {folderId}/
│   │   │   └── {filename}
│   │   └── ...
│   ├── versions/
│   │   └── {fileId}/
│   │       ├── v1
│   │       ├── v2
│   │       └── ...
│   └── temp/
│       └── {temporary_files}
└── ...
```

**Key Points:**
- Files are organized by `userId` for isolation and permission control
- Folder structure mirrors the virtual folder hierarchy in the database
- File naming includes timestamp + random hash for uniqueness: `{name}_{timestamp}_{randomStr}{ext}`
- Version history stored in `/versions/{fileId}/v{number}` structure

### Storage Path Generation
```typescript
// User's base storage directory
/mnt/backup_drive/av-rentals/cloud-storage/{userId}/files/

// File in root folder
/mnt/backup_drive/av-rentals/cloud-storage/{userId}/files/{filename}

// File in subfolder
/mnt/backup_drive/av-rentals/cloud-storage/{userId}/files/{folderId}/{filename}

// File version
/mnt/backup_drive/av-rentals/cloud-storage/{userId}/versions/{fileId}/v{versionNum}
```

**Generated by:** [getStoragePath()](src/lib/storage.ts#L74-L88) and [getVersionPath()](src/lib/storage.ts#L92-L95) functions

### Storage Operations

#### Save File
- Function: `saveFile(buffer: Buffer, filePath: string)`
- Location: [src/lib/storage.ts#L241-L252](src/lib/storage.ts#L241-L252)
- Creates directories automatically if they don't exist
- Writes file buffer to disk using Node.js fs module

#### Read File
- Function: `readFile(filePath: string): Promise<Buffer>`
- Location: [src/lib/storage.ts#L258-L266](src/lib/storage.ts#L258-L266)
- Returns file content as Buffer for serving or processing

#### Delete File
- Function: `deleteFile(filePath: string)`
- Location: [src/lib/storage.ts#L183-L189](src/lib/storage.ts#L183-L189)
- Removes file from disk storage

#### File Versioning
- Function: `copyFile(source: string, destination: string)`
- Location: [src/lib/storage.ts#L220-L232](src/lib/storage.ts#L220-L232)
- Creates backup copies for version history management

---

## 2. Database Metadata Storage

### Database Provider
- **Type:** PostgreSQL 16
- **Connection:** Configured via `DATABASE_URL` environment variable
- **Default:** `postgresql://avrentals_user:avrentals_pass@postgres:5432/avrentals_db`

### Core Cloud Storage Models

#### CloudFile Model
```prisma
model CloudFile {
  id           String        @id @default(cuid())
  name         String        // Display name
  originalName String        // Original uploaded filename
  mimeType     String        // File type (e.g., "application/pdf")
  size         BigInt        // File size in bytes
  storagePath  String        // Path on external disk
  url          String?       // Public URL if shared publicly
  folderId     String?       // Parent folder (if any)
  ownerId      String        // User who owns the file
  isPublic     Boolean       // Public access flag
  isStarred    Boolean       // User favorite flag
  isTrashed    Boolean       // Soft delete flag
  version      Int           // Current version number
  createdAt    DateTime
  updatedAt    DateTime
}
```
**Purpose:** Stores metadata about uploaded files

#### CloudFolder Model
```prisma
model CloudFolder {
  id           String        @id @default(cuid())
  name         String        // Folder name
  parentId     String?       // Parent folder ID (nested structure)
  ownerId      String        // Folder owner
  color        String?       // UI color for folder
  isStarred    Boolean       // Favorite flag
  isTrashed    Boolean       // Soft delete flag
  createdAt    DateTime
  updatedAt    DateTime
}
```
**Purpose:** Manages folder hierarchy and organization

#### FileVersion Model
```prisma
model FileVersion {
  id           String    @id @default(cuid())
  fileId       String    // Reference to CloudFile
  versionNum   Int       // Version number (1, 2, 3...)
  storagePath  String    // Path to versioned file on disk
  size         BigInt    // Version file size
  uploadedAt   DateTime
  uploadedBy   String?   // User who uploaded this version
}
```
**Purpose:** Tracks file version history with separate disk copies

#### StorageQuota Model
```prisma
model StorageQuota {
  id           String   @id @default(cuid())
  userId       String   @unique
  usedBytes    BigInt   // Current usage
  quotaBytes   BigInt   // Storage limit (default: 10GB)
  lastUpdated  DateTime
}
```
**Purpose:** Tracks per-user storage usage and quotas

#### FileActivity Model
```prisma
model FileActivity {
  id           String    @id @default(cuid())
  fileId       String    // File being acted upon
  userId       String    // User performing action
  action       String    // 'created', 'uploaded', 'renamed', 'moved', 'shared', 'deleted', 'restored'
  details      String?   // JSON with additional action details
  createdAt    DateTime
}
```
**Purpose:** Audit trail of all file operations

#### File Sharing Models
```prisma
model FileShare {
  id           String
  fileId       String
  sharedWith   String?        // userId or null for public
  permission   String         // 'view', 'comment', 'edit', 'admin'
  shareToken   String?        // Public link token
  expiresAt    DateTime?      // Share expiration
}

model FolderShare {
  id           String
  folderId     String
  sharedWith   String?        // userId or null for public
  permission   String         // 'view', 'comment', 'edit', 'admin'
  shareToken   String?        // Public link token
  expiresAt    DateTime?      // Share expiration
}
```
**Purpose:** Manages file and folder sharing/permissions

---

## 3. Storage Quotas & Capacity Management

### Quota Configuration
```
DEFAULT_STORAGE_QUOTA=10737418240  // 10 GB per user
STORAGE_CHECK_INTERVAL=300000      // Check disk health every 5 minutes
ENABLE_STORAGE_DISK_CHECK=true     // Enable disk health checks
```

### Space Validation
**Checks in [src/app/api/cloud/files/upload/route.ts](src/app/api/cloud/files/upload/route.ts):**

1. **User Quota Check** (Line 77-81)
   - Verifies user hasn't exceeded their 10GB quota
   - Returns 400 error if quota exceeded

2. **Disk Space Check** (Line 83-90)
   - Verifies system disk has enough space
   - Maintains 5GB buffer minimum free space
   - Returns 507 error if disk full

3. **Empty File Check** (Line 73-76)
   - Prevents uploading empty files

### Disk Health Monitoring
**Function:** `checkDiskHealth()` in [src/lib/storage.ts#L30-L68](src/lib/storage.ts#L30-L68)

- Checks disk accessibility and write permissions
- Uses `df -B1` command to get disk usage statistics
- Calculates available space, total space, and used percentage
- Results cached for 5 minutes to reduce I/O overhead
- Returns health status with last check timestamp

---

## 4. File Upload Flow

### Complete Upload Process

```
User Uploads File
    ↓
1. Authentication Check (JWT token)
    ↓
2. Extract FormData (folderId, files)
    ↓
3. Verify Folder Exists & Accessible
    ↓
4. Create User Storage Directories
    ↓
5. Get User Storage Quota
    ↓
For Each File:
    ├─→ Check File Size > 0
    ├─→ Check Quota Not Exceeded
    ├─→ Check Disk Has Space
    ├─→ Generate Unique Filename
    │   └─→ Format: {name}_{timestamp}_{randomStr}{ext}
    ├─→ Get Storage Path
    │   └─→ /mnt/backup_drive/av-rentals/cloud-storage/{userId}/files/{folderId?}/{filename}
    ├─→ Convert File to Buffer
    ├─→ Save to Disk via saveFile()
    ├─→ Create Database Record (CloudFile)
    ├─→ Log Activity (FileActivity)
    └─→ Update Quota
    ↓
7. Update StorageQuota Record
    ↓
8. Return Response with File IDs & Errors
```

**Endpoint:** [POST /api/cloud/files/upload](src/app/api/cloud/files/upload/route.ts#L24)

---

## 5. Data Consistency & Integrity

### How Data Is Kept Consistent

1. **Atomic Operations**
   - File is saved to disk BEFORE database record created
   - If DB fails, cleanup doesn't happen (orphaned file)
   - If disk fails, DB transaction rolls back

2. **Referential Integrity**
   - PostgreSQL foreign keys ensure orphaned records cleaned up
   - `onDelete: Cascade` on CloudFile → deletes FileActivity, FileShare, FileVersion
   - `onDelete: SetNull` on folderId → keeps file if folder deleted

3. **Soft Deletes**
   - Files marked `isTrashed = true` instead of hard deleted
   - Actual disk deletion happens separately

4. **Activity Logging**
   - Every file operation logged to FileActivity
   - Audit trail of all user actions
   - Activity logging errors ignored (non-blocking)

---

## 6. Data Security & Access Control

### File Ownership
- Every file/folder must have `ownerId`
- API verifies ownership before allowing access
- Users can only access their own files/folders (unless shared)

### Sharing Permissions
```typescript
Permissions: 'view' | 'comment' | 'edit' | 'admin'
```
- Public shares tracked via `shareToken`
- Optional expiration dates on shares
- Granular per-file/folder sharing

### Authentication
- JWT token required for all cloud operations
- Token verified via `verifyAuth()` in request
- Session-based with configurable secret (`JWT_SECRET`)

---

## 7. Storage Initialization

### Directory Creation
**Function:** `createUserStorageDirectories()` in [src/lib/storage.ts#L161-L171](src/lib/storage.ts#L161-L171)

Creates three directories per user:
1. `{userId}/files/` - For user's files
2. `{userId}/versions/` - For version history
3. `{userId}/temp/` - For temporary uploads

### Storage Startup
**Function:** `ensureStorageDirectories()` in [src/lib/storage.ts#L149-L159](src/lib/storage.ts#L149-L159)

- Creates main storage path if doesn't exist
- Creates temp directory for temporary files
- Runs on application startup

---

## 8. Container & Volume Management (Docker)

### Current Configuration
The current `docker-compose.yml` **does NOT mount the cloud storage volume**.

**Issue:** Files are saved to `/mnt/backup_drive/av-rentals/cloud-storage` on the **host machine**, not within the container.

### Recommended Fix
Add volume mount to app service:
```yaml
app:
  volumes:
    - /mnt/backup_drive/av-rentals/cloud-storage:/mnt/backup_drive/av-rentals/cloud-storage
```

This ensures:
- Container can read/write files from host's external storage
- Files persist when container restarts
- Storage accessible to all container instances

---

## 9. Temporary Files Cleanup

### Cleanup Process
**Function:** `cleanupTempDirectory()` in [src/lib/storage.ts#L290-L310](src/lib/storage.ts#L290-L310)

- Removes files older than 24 hours from `/mnt/backup_drive/av-rentals/cloud-storage/temp`
- Should be run periodically (e.g., cron job)
- Prevents disk space bloat from failed uploads or orphaned temp files

---

## Summary

| Component | Storage Location | Technology | Purpose |
|-----------|------------------|-----------|---------|
| **File Content** | `/mnt/backup_drive/av-rentals/cloud-storage` | Linux File System | Store actual uploaded files |
| **File Metadata** | PostgreSQL DB | cloudFile table | File info, ownership, access |
| **Folder Structure** | PostgreSQL DB | cloudFolder table | Virtual folder hierarchy |
| **File Versions** | `/mnt/backup_drive/av-rentals/cloud-storage/{userId}/versions/` + PostgreSQL | File System + DB | Version history tracking |
| **User Quotas** | PostgreSQL DB | storageQuota table | Track per-user disk usage |
| **Activity Logs** | PostgreSQL DB | fileActivity table | Audit trail of operations |
| **Sharing Info** | PostgreSQL DB | fileShare, folderShare tables | Share permissions & tokens |
| **Temporary Files** | `/mnt/backup_drive/av-rentals/cloud-storage/temp/` | Linux File System | Intermediate upload storage |

This architecture provides:
- ✅ Scalable file storage on external disk
- ✅ Fast metadata queries via database
- ✅ Complete audit trail
- ✅ Per-user quotas and access control
- ✅ File versioning support
- ✅ Flexible sharing mechanisms
