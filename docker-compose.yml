# ============================================================
# Docker Compose - Acrobaticz Elite Production Stack
# Multi-service configuration with PostgreSQL, MinIO, and Next.js
# 
# Features:
# - PostgreSQL 16 with health checks
# - MinIO S3-compatible object storage (with external volume mapping)
# - Next.js 15 standalone application
# - Nginx reverse proxy (optional SSL/TLS)
# - Isolated network for security
# 
# Usage:
#   docker-compose up -d
#   # Access: http://localhost:3000 (app)
#   #         http://localhost:9001 (MinIO console - optional)
# 
# Configuration:
#   Create .env file with required variables (see .env.example)
# ============================================================

version: '3.9'

services:
  # ============================================================
  # PostgreSQL 16 Database (Primary Datastore)
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: acrobaticz-postgres
    restart: unless-stopped
    
    # Environment: Database credentials from .env
    environment:
      POSTGRES_DB: ${DB_NAME:-acrobaticz}
      POSTGRES_USER: ${DB_USER:-acrobaticz_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_strong_password_123}
      POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB -c max_connections=100"
    
    # Persistent storage for database files
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # Robust health check with retries
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-acrobaticz_user} -d ${DB_NAME:-acrobaticz}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    
    networks:
      - acrobaticz-network
    
    # Resource constraints (adjust for your hardware)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '1'
          memory: 256M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MinIO S3-Compatible Object Storage
  # 
  # Supports:
  # - Local storage (default)
  # - External disk (via STORAGE_PATH in .env)
  # - NAS/Network paths
  # 
  # Access:
  # - S3 API: http://minio:9000
  # - Web Console: http://localhost:9001
  # ============================================================
  minio:
    image: minio/minio:latest
    container_name: acrobaticz-minio
    restart: unless-stopped
    
    # Root credentials for MinIO admin
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin_change_me_123}
    
    # Volume mapping: Local or external disk
    volumes:
      # Map to external disk: set STORAGE_PATH=/path/to/external/disk in .env
      # Default: ./storage/minio (relative to docker-compose location)
      - ${STORAGE_PATH:-./storage/minio}:/minio/data
    
    # Command to start MinIO in server mode
    command: server /minio/data --console-address :9001
    
    # Expose ports
    ports:
      # 9000: MinIO S3 API (internal + external)
      # 9001: MinIO Web Console (optional - commented for production)
      - "9000:9000"
      # Uncomment below for local development/management
      # - "9001:9001"
    
    # Robust health check with retries
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    
    networks:
      - acrobaticz-network
    
    # Resource constraints
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.5'
          memory: 128M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Acrobaticz Application (Next.js 15 Standalone)
  # ============================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - acrobaticz:latest
    
    image: acrobaticz:latest
    container_name: acrobaticz-app
    restart: unless-stopped
    
    # Environment configuration from .env
    environment:
      # Next.js Configuration
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      HOSTNAME: 0.0.0.0
      NEXT_TELEMETRY_DISABLED: 1
      
      # Database Connection
      DATABASE_URL: postgresql://${DB_USER:-acrobaticz_user}:${DB_PASSWORD:-change_me_strong_password_123}@postgres:5432/${DB_NAME:-acrobaticz}?schema=public
      
      # JWT Authentication
      JWT_SECRET: ${JWT_SECRET:-please_change_this_secret_key_in_production_123}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      
      # MinIO/S3 Configuration
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin_change_me_123}
      S3_BUCKET: ${S3_BUCKET:-acrobaticz}
      S3_REGION: ${S3_REGION:-us-east-1}
      
      # Optional: Translation API
      DEEPL_API_KEY: ${DEEPL_API_KEY:-}
      
      # Optional: Custom domain
      DOMAIN: ${DOMAIN:-localhost:3000}
    
    # Persistent volumes
    volumes:
      # Local app storage (redundant with MinIO, kept for compatibility)
      - app_storage:/app/public/uploads
      # Optional: Map local directory for development
      # - ./app-data:/app/data
    
    # Wait for PostgreSQL and MinIO to be healthy
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    
    # Ports
    ports:
      - "${PORT:-3000}:3000"
    
    # Robust health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    
    networks:
      - acrobaticz-network
    
    # Resource constraints
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Nginx Reverse Proxy (Optional - for SSL/TLS and Load Balancing)
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: acrobaticz-nginx
    restart: unless-stopped
    
    # Ports (80: HTTP, 443: HTTPS)
    ports:
      - "80:80"
      - "443:443"
    
    # Configuration and certificates
    volumes:
      # Nginx configuration
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # SSL certificates
      - nginx_certs:/etc/nginx/certs:ro
      # Static files
      - ./public:/usr/share/nginx/html/static:ro
    
    # Environment
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    
    # Wait for app to be healthy
    depends_on:
      - app
    
    networks:
      - acrobaticz-network
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    # Resource constraints
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================
# Volumes (Persistent Data Storage)
# ============================================================
volumes:
  # PostgreSQL data
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/postgres
  
  # MinIO S3 storage (local or external disk)
  # Mapeado via ${STORAGE_PATH} - ver docker-compose config acima
  
  # App storage (local uploads)
  app_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/app_storage
  
  # Nginx SSL certificates
  nginx_certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./certs

# ============================================================
# Networks
# ============================================================
networks:
  acrobaticz-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-acrobaticz
    ipam:
      config:
        - subnet: 172.20.0.0/16
