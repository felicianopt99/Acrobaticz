#!/bin/bash

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ DEPLOY CHECKLIST - Acrobaticz Production
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ DEPLOY CHECKLIST - Acrobaticz Production"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PRร-REQUISITOS
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PRร-REQUISITOS:"
echo "  โ SSH key configurada (ssh-keygen se necessรกrio)"
echo "  โ Acesso SSH ao servidor: ssh user@host"
echo "  โ Servidor tem: Node.js 20+, PostgreSQL, npm"
echo "  โ Diretรณrio /app/acrobaticz existe e estรก vazio ou preparado"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 1: VALIDAรรO LOCAL
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASSO 1: Validaรงรฃo local"
echo "  Executar:"
echo "    npm run typecheck        # TypeScript"
echo "    npm run build            # Build test"
echo "    npm run test:run         # Testes rรกpidos"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 2: CONFIGURAR VARIรVEIS
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โ๏ธ  PASSO 2: Preparar .env.production LOCAL"
echo "  Editar .env.production com:"
echo ""
echo "    # Database"
echo "    DATABASE_URL=\"postgresql://user:pass@host:5432/acrobaticz\""
echo ""
echo "    # NextAuth"
echo "    NEXTAUTH_URL=\"https://seu-dominio.com\""
echo "    NEXTAUTH_SECRET=\"\$(openssl rand -base64 32)\""
echo ""
echo "    # Upload Storage"
echo "    STORAGE_TYPE=\"s3\"  # ou 'local' para arquivo local"
echo "    S3_BUCKET=\"seu-bucket\""
echo "    S3_REGION=\"eu-west-1\""
echo ""
echo "    # Email (SendGrid ou similar)"
echo "    SENDGRID_API_KEY=\"...\""
echo ""
echo "    NODE_ENV=\"production\""
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 3: TESTAR CONEXรO SSH
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASSO 3: Testar SSH"
echo "  Executar:"
echo "    ssh deploy@seu-servidor.com \"echo โ SSH OK\""
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 4: DEPLOY
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASSO 4: Deploy (Build Local)"
echo ""
echo "  OPรรO A: Teste rรกpido (DRY-RUN)"
echo "    chmod +x deploy-ssh-fast.sh"
echo "    ./deploy-ssh-fast.sh deploy@seu-servidor.com:/app/acrobaticz --dry-run"
echo ""
echo "  OPรรO B: Deploy real"
echo "    chmod +x deploy-ssh-fast.sh"
echo "    ./deploy-ssh-fast.sh deploy@seu-servidor.com:/app/acrobaticz"
echo ""
echo "  O script irรก:"
echo "    1. Build local (.next)"
echo "    2. Comprimir build + configs"
echo "    3. Enviar via SCP"
echo "    4. Servidor extrai e inicia"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 5: VERIFICAรรO NO SERVIDOR
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โ๏ธ  PASSO 5: Verificaรงรฃo (no servidor)"
echo "  Conectar e validar:"
echo ""
echo "    ssh deploy@seu-servidor.com"
echo "    cd /app/acrobaticz/app"
echo ""
echo "    # Ver logs da aplicaรงรฃo"
echo "    npm run start"
echo ""
echo "    # Ou em outro terminal"
echo "    curl http://localhost:3000/api/health"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 6: NGINX REVERSE PROXY (opcional)
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASSO 6: Nginx Reverse Proxy (opcional)"
echo "  No servidor, configurar:"
echo ""
echo "    server {"
echo "        listen 80;"
echo "        server_name seu-dominio.com;"
echo ""
echo "        location / {"
echo "            proxy_pass http://localhost:3000;"
echo "            proxy_http_version 1.1;"
echo "            proxy_set_header Upgrade \$http_upgrade;"
echo "            proxy_set_header Connection 'upgrade';"
echo "            proxy_set_header Host \$host;"
echo "            proxy_cache_bypass \$http_upgrade;"
echo "        }"
echo "    }"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 7: MONITORAMENTO E LOGS
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PASSO 7: Monitoramento"
echo "  Manter rodando com PM2:"
echo ""
echo "    npm install -g pm2"
echo "    pm2 start npm --name \"acrobaticz\" -- start"
echo "    pm2 save"
echo "    pm2 startup"
echo ""
echo "  Verificar status:"
echo "    pm2 status"
echo "    pm2 logs acrobaticz"
echo ""

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMO RรPIDO
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โก QUICK START (30 SEGUNDOS):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "1. chmod +x deploy-ssh-fast.sh"
echo ""
echo "2. ./deploy-ssh-fast.sh deploy@prod.com:/app/acrobaticz --dry-run"
echo ""
echo "3. ./deploy-ssh-fast.sh deploy@prod.com:/app/acrobaticz"
echo ""
echo "โ Done!"
echo ""
