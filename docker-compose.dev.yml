# ============================================================
# Docker Compose for Development (Production-like Setup)
# Simulates full production environment locally
# Use: docker-compose -f docker-compose.dev.yml up
# 
# Services:
# - PostgreSQL 16 (database)
# - MinIO (S3-compatible storage)
# - Next.js App (development mode with hot-reload)
# - Nginx (reverse proxy - optional)
#
# Features:
# - Full setup flow validation (like production)
# - Hot reload development experience
# - Complete service dependencies
# - Health checks on all services
# ============================================================

version: '3.9'

services:
  # ============================================================
  # PostgreSQL Database (Production-like)
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: acrobaticz-postgres-dev
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: ${DB_NAME:-acrobaticz_dev}
      POSTGRES_USER: ${DB_USER:-acrobaticz_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password_123}
      POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB -c max_connections=100"
    
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-acrobaticz_user} -d ${DB_NAME:-acrobaticz_dev}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    
    ports:
      - "5432:5432"
    
    networks:
      - acrobaticz-dev-network
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '1'
          memory: 256M
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MinIO S3-Compatible Storage (Production-like)
  # ============================================================
  minio:
    image: minio/minio:latest
    container_name: acrobaticz-minio-dev
    restart: unless-stopped
    
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin_dev_123}
    
    volumes:
      # Use local dev-storage for MinIO data
      - ./dev-storage/minio:/minio/data
    
    command: server /minio/data --console-address :9001
    
    ports:
      - "9000:9000"    # MinIO S3 API
      - "9001:9001"    # MinIO Web Console (dev only)
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    
    networks:
      - acrobaticz-dev-network
    
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.5'
          memory: 128M
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Next.js Application (Development with Hot Reload)
  # Uses development Dockerfile for faster builds and debugging
  # ============================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
      cache_from:
        - acrobaticz:dev
    
    image: acrobaticz:dev
    container_name: acrobaticz-app-dev
    restart: unless-stopped
    
    environment:
      # Node/Next.js Configuration
      NODE_ENV: development
      PORT: 3000
      HOSTNAME: 0.0.0.0
      NEXT_TELEMETRY_DISABLED: 1
      NODE_OPTIONS: --max-old-space-size=2048
      
      # Database Connection (simulates production)
      DATABASE_URL: postgresql://${DB_USER:-acrobaticz_user}:${DB_PASSWORD:-dev_password_123}@postgres:5432/${DB_NAME:-acrobaticz_dev}?schema=public
      
      # JWT Authentication
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-for-local-development-only}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      
      # MinIO/S3 Configuration (simulates production)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin_dev_123}
      S3_BUCKET: ${S3_BUCKET:-acrobaticz-dev}
      S3_REGION: ${S3_REGION:-us-east-1}
      
      # ==============================================
      # Database Seeding Configuration
      # ==============================================
      # Auto-seed when database is empty (recommended for dev)
      SEED_ON_START: ${SEED_ON_START:-true}
      # Force clean seed on every startup (use with caution)
      FORCE_SEED: ${FORCE_SEED:-false}
      # Clean database before seeding
      SEED_CLEAN: ${SEED_CLEAN:-false}
      # Verbose seed output
      SEED_VERBOSE: ${SEED_VERBOSE:-false}
      
      # Optional: Translation API
      DEEPL_API_KEY: ${DEEPL_API_KEY:-}
    
    volumes:
      # Source code with hot-reload
      - .:/app
      - /app/node_modules
      - /app/.next
      # Dev storage
      - ./dev-storage:/app/dev-storage
    
    ports:
      - "3000:3000"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    
    networks:
      - acrobaticz-dev-network
    
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G
          cpus: '1'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Nginx Reverse Proxy (Optional - for production-like experience)
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: acrobaticz-nginx-dev
    restart: unless-stopped
    
    ports:
      - "80:80"
      # - "443:443"  # Uncomment if you want HTTPS with self-signed certs
    
    volumes:
      # Nginx configuration
      - ./nginx/app.conf.template:/etc/nginx/templates/default.conf.template:ro
      # Static files
      - ./public:/usr/share/nginx/html/static:ro
    
    environment:
      - DOMAIN=localhost
    
    depends_on:
      - app
    
    networks:
      - acrobaticz-dev-network
    
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================
# Volumes (Persistent Data Storage)
# ============================================================
volumes:
  postgres_dev_data:
    driver: local

# ============================================================
# Networks
# ============================================================
networks:
  acrobaticz-dev-network:
    driver: bridge
