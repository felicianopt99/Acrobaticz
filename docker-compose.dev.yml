# ============================================================
# Docker Compose for Development (Production-like Setup)
# Simulates full production environment locally with hot-reload
# 
# Ultra-Portable Features:
# - Works on Linux, macOS (Intel & Apple Silicon), Windows WSL2
# - Auto-reload on file changes
# - Full service dependencies (PostgreSQL, MinIO)
# - Comprehensive health checks
# - Easy debugging with exposed ports
# 
# Usage:
#   docker-compose -f docker-compose.dev.yml up
#   docker-compose -f docker-compose.dev.yml down
# 
# Access:
#   App: http://localhost:3000
#   MinIO Console: http://localhost:9001
#   PostgreSQL: localhost:5432
# 
# Multi-platform build:
#   docker buildx build --platform linux/amd64,linux/arm64 -t acrobaticz:dev .
# ============================================================

version: '3.9'

services:
  # ============================================================
  # PostgreSQL Database (Production-like)
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: acrobaticz-postgres-dev
    restart: unless-stopped
    pull_policy: if_not_present
    
    environment:
      POSTGRES_DB: ${DB_NAME:-acrobaticz_dev}
      POSTGRES_USER: ${DB_USER:-acrobaticz_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password_123}
      POSTGRES_INITDB_ARGS: >
        -c shared_buffers=256MB
        -c max_connections=100
        -c log_statement=all
        -c log_min_duration_statement=0
    
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    
    # Extended health check for development
    # More verbose to help debug issues
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-acrobaticz_user} -d ${DB_NAME:-acrobaticz_dev} -v"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    
    ports:
      - "5432:5432"
    
    networks:
      - acrobaticz-dev-network
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M
    
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "3"
        labels: "service=postgres,environment=development"

  # ============================================================
  # MinIO S3-Compatible Storage (Production-like)
  # ============================================================
  minio:
    image: minio/minio:latest
    container_name: acrobaticz-minio-dev
    restart: unless-stopped
    pull_policy: if_not_present
    
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin_dev_123}
      # Enable debug logging for development
      MINIO_LOG_LEVEL: ${MINIO_LOG_LEVEL:-info}
    
    volumes:
      # Use local dev-storage for MinIO data
      - ./dev-storage/minio:/minio/data
    
    command: server /minio/data --console-address :9001
    
    ports:
      - "9000:9000"    # MinIO S3 API
      - "9001:9001"    # MinIO Web Console (dev only)
    
    # Extended health check for development
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    
    networks:
      - acrobaticz-dev-network
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "3"
        labels: "service=minio,environment=development"

  # ============================================================
  # Next.js Application (Development with Hot Reload)
  # Uses development Dockerfile for faster builds and debugging
  # 
  # Hot Reload: File changes automatically trigger rebuild
  # Volume Mapping: Source code mounted for instant feedback
  # ============================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
      cache_from:
        - type=registry,ref=acrobaticz:dev
      args:
        - BUILDKIT_INLINE_CACHE=1
    
    image: acrobaticz:dev
    container_name: acrobaticz-app-dev
    restart: unless-stopped
    pull_policy: if_not_present
    
    environment:
      # Node/Next.js Configuration
      NODE_ENV: development
      PORT: 3000
      HOSTNAME: 0.0.0.0
      NEXT_TELEMETRY_DISABLED: 1
      NODE_OPTIONS: --max-old-space-size=2048 --disable-warning=DEP0040
      # Enable debug logging for development
      DEBUG: ${DEBUG:-acrobaticz:*}
      
      # Database Connection (simulates production)
      DATABASE_URL: postgresql://${DB_USER:-acrobaticz_user}:${DB_PASSWORD:-dev_password_123}@postgres:5432/${DB_NAME:-acrobaticz_dev}?schema=public&connect_timeout=10
      
      # JWT Authentication
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-for-local-development-only}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-dev-encryption-key-local-only}
      
      # MinIO/S3 Configuration (simulates production)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin_dev_123}
      S3_BUCKET: ${S3_BUCKET:-acrobaticz-dev}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_USE_PATH_STYLE: "true"
      
      # ==============================================
      # Database Seeding Configuration
      # ==============================================
      # Auto-seed when database is empty (recommended for dev)
      SEED_ON_START: ${SEED_ON_START:-true}
      # Force clean seed on every startup (use with caution)
      FORCE_SEED: ${FORCE_SEED:-false}
      # Clean database before seeding
      SEED_CLEAN: ${SEED_CLEAN:-false}
      # Verbose seed output
      SEED_VERBOSE: ${SEED_VERBOSE:-true}
      
      # Optional: Translation API
      DEEPL_API_KEY: ${DEEPL_API_KEY:-}
      
      # Development options
      VERBOSE_LOGS: "true"
      WATCH_MODE: "true"
    
    volumes:
      # Source code with hot-reload
      # Exclude node_modules and .next from bind mount
      - .:/app
      - /app/node_modules
      - /app/.next
      # Dev storage for S3 uploads
      - ./dev-storage:/app/dev-storage
      # Cache directory
      - ./data/dev_cache:/app/.next/cache
    
    ports:
      - "3000:3000"
    
    # Extended health check for development
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 60s
    
    networks:
      - acrobaticz-dev-network
    
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4'
        reservations:
          memory: 2G
          cpus: '2'
    
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "5"
        labels: "service=app,environment=development"

  # ============================================================
  # Nginx Reverse Proxy (Optional - for production-like experience)
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: acrobaticz-nginx-dev
    restart: unless-stopped
    
    ports:
      - "80:80"
      # - "443:443"  # Uncomment if you want HTTPS with self-signed certs
    
    volumes:
      # Nginx configuration
      - ./nginx/app.conf.template:/etc/nginx/templates/default.conf.template:ro
      # Static files
      - ./public:/usr/share/nginx/html/static:ro
    
    environment:
      - DOMAIN=localhost
    
    depends_on:
      - app
    
    networks:
      - acrobaticz-dev-network
    
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================
# Volumes (Persistent Data Storage)
# ============================================================
volumes:
  postgres_dev_data:
    driver: local

# ============================================================
# Networks
# ============================================================
networks:
  acrobaticz-dev-network:
    driver: bridge
