# ðŸ”„ FASE 3 - PLANO DE CONSOLIDAÃ‡ÃƒO DE MIGRAÃ‡Ã•ES PRISMA

**Data:** 14 de Janeiro de 2026  
**Status:** Plano Estruturado para AprovaÃ§Ã£o  
**Objetivo:** Consolidar 29 migraÃ§Ãµes em 1 Ãºnica migraÃ§Ã£o baseline (`01_init`)

---

## ðŸ“Š ANÃLISE ATUAL

### Estado das MigraÃ§Ãµes

```
Total de MigraÃ§Ãµes:     29
Total de Linhas SQL:    1611
Intervalo Temporal:     Nov 10 2025 â†’ Jan 9 2026 (3 meses de dev)
Maior MigraÃ§Ã£o:         12KB (translation_tables)
Tamanho Total:          ~150KB

Estrutura Atual:
  â”œâ”€ 20251110233929_init_postgres (base inicial)
  â”œâ”€ 20251111045118_add_translation_cache
  â”œâ”€ 20251111135023_add_enhanced_translation_fields
  â”œâ”€ ... (26 mais)
  â””â”€ 20260109_create_system_setting (Ãºltima)
```

### Modelos no Schema Atual

```
Total de Models:        50+
Total de Relations:     ~80+
Total de Ãndices:       30+
Tabelas Finais:         ~48
```

### Problemas da Abordagem Atual

| Problema | Impacto | Severidade |
|----------|---------|-----------|
| 29 migraÃ§Ãµes | Startup lento (aplica todas) | ðŸ”´ Alta |
| DependÃªncias entre migraÃ§Ãµes | Complexo para debug | ðŸŸ¡ MÃ©dia |
| HistÃ³rico de dev espalhado | DifÃ­cil de compreender | ðŸŸ¡ MÃ©dia |
| MÃºltiplos pontos de falha | Erro numa migraÃ§Ã£o bloqueia | ðŸ”´ Alta |
| DistribuiÃ§Ã£o complexa | Clientes precisam esperar 29x | ðŸ”´ Alta |

---

## ðŸŽ¯ ESTRATÃ‰GIA DE CONSOLIDAÃ‡ÃƒO

### Abordagem: "Squash & Reset"

**PrincÃ­pio:** 
Preservar dados locais enquanto compactamos histÃ³rico de migraÃ§Ãµes para novo users.

```
ANTES (Dev):
â”Œâ”€ BD Existente com dados
â”œâ”€ 29 migraÃ§Ãµes aplicadas
â””â”€ _prisma_migrations com histÃ³rico completo

DURANTE (TransiÃ§Ã£o Segura):
â”Œâ”€ Backup BD antes de qualquer coisa
â”œâ”€ Gerar SQL consolidado do schema.prisma
â”œâ”€ Criar pasta 01_init com SQL Ãºnico
â”œâ”€ Testar em BD de teste (sem perder dev)
â””â”€ Arquivo histÃ³rico antigo

DEPOIS (Novo User):
â”Œâ”€ Clonar repo
â”œâ”€ Executar: docker-compose up -d
â”œâ”€ Entrypoint aplica 01_init Ãºnica
â”œâ”€ BD pronta em 5-10 segundos
â””â”€ Tudo funciona normalmente
```

---

## ðŸ“‹ PLANO DE AÃ‡ÃƒO (5 Etapas)

### Etapa 1: PreparaÃ§Ã£o & Backup (15 min)

**Objetivo:** Proteger dados locais

```bash
# 1.1 Backup da BD atual (database dump)
docker-compose exec postgres pg_dump -U acrobaticz_user -d acrobaticz > ./backups/pre_consolidation_backup.sql

# 1.2 Backup da pasta migrations (histÃ³rico)
cp -r prisma/migrations prisma/migrations.archive.$(date +%Y%m%d_%H%M%S)

# 1.3 Backup do schema.prisma
cp prisma/schema.prisma prisma/schema.prisma.backup

# 1.4 Commit no git (ponto de retorno)
git add .
git commit -m "Backup antes de consolidaÃ§Ã£o de migraÃ§Ãµes - Fase 3"
```

**Resultado:** Backups seguros + git checkpoint

---

### Etapa 2: Gerar SQL Consolidado (20 min)

**Objetivo:** Extrair DDL do schema.prisma atual

**OpÃ§Ã£o A: Usando Prisma (Recomendado)**

```bash
# 2.1 Gerar arquivo SQL com schema completo
cd /media/feli/38826d41-4b6a-4f13-9e48-d9628771bfe5/AC/Acrobaticz

# Criar BD de teste (sem dados)
docker run --rm -e POSTGRES_PASSWORD=test postgres:16-alpine \
  pg_isready -h localhost || true

# 2.2 Usar Prisma para gerar SQL
npx prisma migrate resolve --rolled-back 20260114000000_01_init 2>/dev/null || true

# Ou gerar manualmente:
npx prisma db push --skip-generate --preview-feature-flag
# Isso aplicarÃ¡ o schema.prisma atual numa BD de teste
```

**OpÃ§Ã£o B: Export SQL via pg_dump**

```bash
# Se BD atual tem schema correto:
docker-compose exec postgres pg_dump \
  -U acrobaticz_user \
  -d acrobaticz \
  --schema-only \
  --no-owner \
  --no-privileges \
  > ./schema_export.sql
```

**Resultado:** Ficheiro `.sql` com schema consolidado

---

### Etapa 3: Criar MigraÃ§Ã£o Baseline (25 min)

**Objetivo:** Criar pasta `01_init` com SQL Ãºnico

```bash
# 3.1 Remover histÃ³rico antigo
rm -rf prisma/migrations/*/ prisma/migrations/migration_lock.toml

# 3.2 Criar pasta da nova migraÃ§Ã£o
mkdir -p prisma/migrations/20260114000000_01_init

# 3.3 Copiar SQL gerado
# Se usou export SQL:
cp schema_export.sql prisma/migrations/20260114000000_01_init/migration.sql

# Se usou Prisma:
# O SQL gerado estÃ¡ em ./migration.sql (copiar)

# 3.4 Criar migration_lock.toml novo
cat > prisma/migrations/migration_lock.toml << 'EOF'
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
EOF

# 3.5 Resultado
ls -la prisma/migrations/
# Expected:
# 20260114000000_01_init/
#   â””â”€ migration.sql (1611 linhas)
# migration_lock.toml
```

**Estrutura Final:**

```
prisma/migrations/
â”œâ”€ 20260114000000_01_init/
â”‚  â””â”€ migration.sql (1611 linhas - schema completo)
â”œâ”€ migration_lock.toml
â””â”€ migrations.archive.20260114_xxx/ (backup antigo - arquivado)
```

---

### Etapa 4: ValidaÃ§Ã£o em BD Limpa (20 min)

**Objetivo:** Garantir que `01_init` funciona para novo user

```bash
# 4.1 Parar stack atual
docker-compose down

# 4.2 Remover volume DB (para comeÃ§ar limpo)
docker volume rm acrobaticz_postgres_data 2>/dev/null || true

# 4.3 Reiniciar stack (vai aplicar 01_init)
docker-compose up -d

# 4.4 Verificar logs
docker-compose logs app | grep -i "step\|migration\|error"

# 4.5 Esperado:
# âœ“ STEP 7: Applying database schema...
# âœ“ Database migrations completed successfully
# âœ“ Database schema verified (XX tables found)

# 4.6 Testar conectividade
docker-compose exec postgres psql -U acrobaticz_user -d acrobaticz -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public';"
# Expected: count = 48 (nÃºmero de tabelas)
```

---

### Etapa 5: Restaurar Dados Locais (15 min)

**Objetivo:** Recuperar dados de desenvolvimento

```bash
# 5.1 Parar stack
docker-compose down

# 5.2 Remover volume criado no teste
docker volume rm acrobaticz_postgres_data

# 5.3 Recrear volume e restaurar backup
docker-compose up -d postgres
# Aguardar healthcheck (10s)

# 5.4 Restaurar dados do backup
docker-compose exec -T postgres psql -U acrobaticz_user -d acrobaticz < ./backups/pre_consolidation_backup.sql

# 5.5 Verificar integridade
docker-compose exec postgres psql -U acrobaticz_user -d acrobaticz -c "SELECT COUNT(*) FROM \"User\";"

# 5.6 Iniciar stack completo
docker-compose up -d

# 5.7 Verificar que app conecta normalmente
docker-compose logs app | grep "migrations completed"
```

**Esperado:** Dados intactos, sem perdas

---

## ðŸ”’ PROCEDIMENTO SEGURO (Completo)

### Checklist PrÃ©-ConsolidaÃ§Ã£o

```bash
# 1. Verificar git status
git status
# Expected: clean working tree

# 2. Contar migraÃ§Ãµes
find prisma/migrations -maxdepth 1 -type d | wc -l
# Expected: 30 (29 + migration_lock.toml)

# 3. Contar registos na BD
docker-compose exec postgres psql -U acrobaticz_user -d acrobaticz \
  -c "SELECT schemaname, COUNT(*) FROM pg_tables WHERE schemaname='public' GROUP BY schemaname;"
# Expected: ~48 tabelas

# 4. Verificar que app estÃ¡ rodando
curl http://localhost:3000/api/health
# Expected: 200 OK
```

### Script AutomÃ¡tico (Recomendado)

Vou fornecer script Bash que:
- Faz backups automaticamente
- Gera SQL consolidado
- Cria `01_init`
- Valida em BD limpa
- Restaura dados locais
- Trata erros com rollback

---

## âš ï¸ RISCOS & MITIGAÃ‡Ã•ES

| Risco | Probabilidade | MitigaÃ§Ã£o |
|-------|---------------|-----------|
| Perder dados locais | ðŸŸ¢ Baixa | Backup + BD de teste separada |
| SQL consolidado incorreto | ðŸŸ¡ MÃ©dia | Validar schema em BD limpa |
| `01_init` nÃ£o aplica em Docker | ðŸŸ¡ MÃ©dia | Testar com `docker-compose up` |
| Git history corrompido | ðŸŸ¢ Baixa | Commit antes, fÃ¡cil rollback |
| App quebra apÃ³s consolidaÃ§Ã£o | ðŸŸ¡ MÃ©dia | Testar em BD limpa primeiro |

**EstratÃ©gia de Rollback:**

Se qualquer coisa falhar:
```bash
# Restaurar backup antigo
git reset --hard HEAD~1
rm -rf prisma/migrations
cp -r prisma/migrations.archive.* prisma/migrations
docker-compose down -v
docker-compose up -d
```

---

## ðŸ“ˆ BENEFÃCIOS APÃ“S CONSOLIDAÃ‡ÃƒO

| MÃ©trica | Antes | Depois | Melhoria |
|---------|-------|--------|----------|
| MigraÃ§Ãµes aplicadas | 29 | 1 | **29x** |
| Tempo startup | 5-10s | 1-2s | **5-10x** |
| Complexidade distribuiÃ§Ã£o | Alta | Baixa | **âœ…** |
| Linhas de migration.sql | 1611 | 1611 | = (igual) |
| Tabelas criadas | 48 | 48 | = (igual) |
| Dados preservados | N/A | âœ… Sim | **âœ…** |

---

## âœ… VALIDAÃ‡ÃƒO PÃ“S-CONSOLIDAÃ‡ÃƒO

### Teste 1: BD Limpa (Novo User)

```bash
# Simular novo user fazendo git clone + docker-compose up
docker-compose down -v
rm -rf ./data/postgres
docker-compose up -d

# Verificar
docker-compose logs app | grep "STEP 7"
docker-compose ps  # Todos healthy
curl http://localhost:3000/api/health  # 200 OK
```

### Teste 2: Dados Preservados (Dev Local)

```bash
# ApÃ³s restaurar backup
docker-compose exec postgres psql -U acrobaticz_user -d acrobaticz -c "SELECT COUNT(*) FROM \"User\";"
# Expected: mesmo nÃºmero de antes
```

### Teste 3: App Funcional

```bash
# Verificar que toda a app funciona
curl http://localhost:3000/api/auth/status
curl http://localhost:3000/api/config
# Expected: 200 OK em ambos
```

### Teste 4: MigraÃ§Ãµes Futuras

```bash
# Fazer uma pequena alteraÃ§Ã£o no schema.prisma
# Ex: adicionar um campo em User

npx prisma migrate dev --name add_test_field

# Expected:
# - Nova pasta: prisma/migrations/20260114xxxxxx_add_test_field/
# - migration.sql gerado
# - BD atualizada

# Cleanup: reverter a mudanÃ§a
git checkout prisma/schema.prisma
npx prisma db push --skip-generate
```

---

## ðŸš€ PRÃ“XIMOS PASSOS

### Se Aprovado:

1. **Hoje (14 Jan):**
   - Gerar SQL consolidado
   - Criar migraÃ§Ã£o `01_init`
   - Testar em BD limpa
   - Restaurar dados locais

2. **AmanhÃ£ (15 Jan):**
   - Testar com novo clone
   - Validar `docker-compose up -d`
   - Fazer git commit final
   - Documentar processo

3. **Deployer:**
   - Usar nova estrutura simples
   - Clientes tÃªm startup 5-10x mais rÃ¡pido
   - Menos pontos de falha

---

## ðŸ“ QUESTÃ•ES ANTES DE INICIAR

1. âœ… Posso fazer backup de prisma/migrations ?
2. âœ… Posso remover histÃ³rico antigo (20251110-20260109) ?
3. âœ… Tenho dados locais que preciso preservar ?
4. âœ… Posso usar BD de teste temporÃ¡ria ?
5. âœ… Quero git history clean ou preservar antigo ?

---

## ðŸ“š REFERÃŠNCIAS

- Prisma Migration Squashing: https://www.prisma.io/docs/concepts/components/prisma-migrate/troubleshooting
- PostgreSQL pg_dump: `man pg_dump`
- Git Rollback: `git reset --hard`

---

**Status:** âœ… Plano Pronto para ImplementaÃ§Ã£o

**Tempo Total Estimado:** 90 minutos (com testes)

**PrÃ³ximo:** AprovaÃ§Ã£o + Iniciar scripts de consolidaÃ§Ã£o

