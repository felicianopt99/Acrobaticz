# ğŸ—ï¸ Arquitetura Integrada - Diagrama Visual

## ğŸ“Š Fluxo Geral da Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT REQUEST                                  â”‚
â”‚                                                                          â”‚
â”‚  POST /api/rentals                                                     â”‚
â”‚  Headers: { Authorization, X-Request-ID, IP, User-Agent }             â”‚
â”‚  Body: { clientId, equipmentIds, startDate, endDate, totalPrice, ... }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ” LAYER 1: withSafety() HOC Wrapper                       â”‚
â”‚  (src/lib/api-wrapper.ts)                                              â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Extract Context                                               â”‚ â”‚
â”‚  â”‚    â”œâ”€ userId (from JWT header)                                   â”‚ â”‚
â”‚  â”‚    â”œâ”€ ipAddress (from X-Forwarded-For or IP)                    â”‚ â”‚
â”‚  â”‚    â”œâ”€ userAgent (from User-Agent header)                        â”‚ â”‚
â”‚  â”‚    â”œâ”€ requestId (unique ID for tracking)                        â”‚ â”‚
â”‚  â”‚    â””â”€ setOperationContext({ ... }) â† Stored for later use      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 2. Rate Limit Check (10 req/min for WRITE)                       â”‚ â”‚
â”‚  â”‚    â”œâ”€ Key: "rate-limit:192.168.1.1"                             â”‚ â”‚
â”‚  â”‚    â”œâ”€ Store: in-memory Map                                       â”‚ â”‚
â”‚  â”‚    â”œâ”€ Window: 60 seconds                                         â”‚ â”‚
â”‚  â”‚    â”œâ”€ Max: 10 requests                                           â”‚ â”‚
â”‚  â”‚    â””â”€ If exceeded â†’ 429 Too Many Requests                        â”‚ â”‚
â”‚  â”‚                     + Retry-After header                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 3. Input Validation (Zod Schema)                                 â”‚ â”‚
â”‚  â”‚    â”œâ”€ Schema: RentalCreateSchema                                 â”‚ â”‚
â”‚  â”‚    â”œâ”€ Checks:                                                    â”‚ â”‚
â”‚  â”‚    â”‚  â”œâ”€ Type checking (string, number, UUID, etc)              â”‚ â”‚
â”‚  â”‚    â”‚  â”œâ”€ Required fields validation                             â”‚ â”‚
â”‚  â”‚    â”‚  â”œâ”€ Range validation (startDate < endDate)                 â”‚ â”‚
â”‚  â”‚    â”‚  â”œâ”€ Enum validation (status in [PENDING, CONFIRMED, ...]) â”‚ â”‚
â”‚  â”‚    â”‚  â””â”€ Transform: DOMPurify sanitization (XSS removal)        â”‚ â”‚
â”‚  â”‚    â””â”€ If invalid â†’ 400 Bad Request                             â”‚ â”‚
â”‚  â”‚                   + Details of validation errors                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                    âœ… All validations passed                            â”‚
â”‚                                    â†“                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HANDLER FUNCTION EXECUTES                            â”‚
â”‚          (Custom business logic in /api/rentals/route.ts)              â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 4. Business Logic Validation                                     â”‚ â”‚
â”‚  â”‚    â”œâ”€ Verify client exists                                       â”‚ â”‚
â”‚  â”‚    â”‚  â””â”€ await prisma.client.findUnique({ where: { id } })     â”‚ â”‚
â”‚  â”‚    â”œâ”€ Verify equipment exists                                    â”‚ â”‚
â”‚  â”‚    â”‚  â””â”€ await prisma.equipmentItem.count({ where: { id } })   â”‚ â”‚
â”‚  â”‚    â”œâ”€ Check for scheduling conflicts (optional)                 â”‚ â”‚
â”‚  â”‚    â””â”€ If validation fails â†’ return errorResponse()              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                    âœ… Business logic validation passed                  â”‚
â”‚                                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 5. Execute Prisma Operation                                      â”‚ â”‚
â”‚  â”‚    â””â”€ const rental = await prisma.rental.create({                â”‚ â”‚
â”‚  â”‚         data: { clientId, startDate, endDate, ... }              â”‚ â”‚
â”‚  â”‚       })                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â†“                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ğŸ” LAYER 4&5: Prisma-Extended Middleware Intercepts           â”‚
â”‚  (src/lib/prisma-extended.ts - $extends)                              â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ QUERY PHASE (executed BEFORE database query)                     â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ â€¢ This is CREATE operation, not a read â†’ no soft-delete filter  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DATABASE EXECUTION                                               â”‚ â”‚
â”‚  â”‚ INSERT INTO "Rental" (id, clientId, startDate, ...) VALUES (...)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RESULT PHASE (executed AFTER database query)                     â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ â€¢ Intercept result and trigger logging                            â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ await logActivityOperation({                                     â”‚ â”‚
â”‚  â”‚   operation: 'create',                                           â”‚ â”‚
â”‚  â”‚   model: 'Rental',                                               â”‚ â”‚
â”‚  â”‚   args: { data: { ... } },                                       â”‚ â”‚
â”‚  â”‚   result: { id: '123', clientId: '456', ... },                  â”‚ â”‚
â”‚  â”‚   context: { userId, ipAddress, userAgent, requestId }           â”‚ â”‚
â”‚  â”‚ })                                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ¡ LAYER 5: Activity Logging (Automatic)                         â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ INSERT INTO "ActivityLog" (                                      â”‚ â”‚
â”‚  â”‚   id: 'log-789',                    â† Generated CUID            â”‚ â”‚
â”‚  â”‚   userId: 'user-123',                â† From context             â”‚ â”‚
â”‚  â”‚   entityType: 'Rental',              â† Model name               â”‚ â”‚
â”‚  â”‚   entityId: 'rental-456',            â† Created ID               â”‚ â”‚
â”‚  â”‚   action: 'CREATE',                  â† Operation type           â”‚ â”‚
â”‚  â”‚   changes: {},                       â† CREATE has no old value  â”‚ â”‚
â”‚  â”‚   ipAddress: '192.168.1.1',          â† From context             â”‚ â”‚
â”‚  â”‚   userAgent: 'Mozilla/5.0...',       â† From context             â”‚ â”‚
â”‚  â”‚   createdAt: 2026-01-15T10:00:00Z    â† Timestamp               â”‚ â”‚
â”‚  â”‚ )                                                                â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ âœ… Activity Log created (non-blocking)                           â”‚ â”‚
â”‚  â”‚ âš ï¸ If logging fails, main operation still succeeds               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ğŸŸ¢ SUCCESS: Return to Handler                         â”‚
â”‚                   result: { id: 'rental-456', ... }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HANDLER CONTINUES (Optional)                          â”‚
â”‚                                                                          â”‚
â”‚  â€¢ Emit Socket.IO event (real-time sync)                              â”‚
â”‚    io.to('sync-rental').emit('rental:created', rental)                â”‚
â”‚                                                                          â”‚
â”‚  â€¢ Return success response                                             â”‚
â”‚    return successResponse(rental, requestId, 201)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ” LAYER 1: withSafety() HOC Wrapper (FINAL)              â”‚
â”‚  (src/lib/api-wrapper.ts)                                              â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 6. Catch Errors (if any)                                         â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ try-catch block intercepta:                                      â”‚ â”‚
â”‚  â”‚  â€¢ Prisma errors (P2002, P2025, etc) â†’ handlePrismaError()      â”‚ â”‚
â”‚  â”‚  â€¢ Zod errors â†’ handleZodError()                                â”‚ â”‚
â”‚  â”‚  â€¢ Generic errors â†’ handleApiError()                            â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚ Mapeamento de Erros Prisma:                                     â”‚ â”‚
â”‚  â”‚  P2002 â†’ 409 Conflict (Unique constraint)                       â”‚ â”‚
â”‚  â”‚  P2025 â†’ 404 Not Found (Record not found)                       â”‚ â”‚
â”‚  â”‚  P2003 â†’ 400 Bad Request (Foreign key)                          â”‚ â”‚
â”‚  â”‚  P2024 â†’ 503 Service Unavailable (Database down)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 7. Add Rate Limit Headers                                        â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  X-RateLimit-Limit: 10       â† Max requests per window          â”‚ â”‚
â”‚  â”‚  X-RateLimit-Remaining: 9    â† Remaining in this window         â”‚ â”‚
â”‚  â”‚  X-RateLimit-Reset: 1673... â† Unix timestamp when resets       â”‚ â”‚
â”‚  â”‚  X-Request-ID: req-123...    â† For tracing                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 8. Cleanup                                                        â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  clearOperationContext()  â† Remove userId, IP from context      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ğŸ‰ CLIENT RESPONSE                               â”‚
â”‚                                                                          â”‚
â”‚  HTTP 201 Created                                                      â”‚
â”‚                                                                          â”‚
â”‚  Headers:                                                              â”‚
â”‚    X-RateLimit-Limit: 10                                              â”‚
â”‚    X-RateLimit-Remaining: 9                                           â”‚
â”‚    X-RateLimit-Reset: 1673779500000                                   â”‚
â”‚    X-Request-ID: req-123456789                                        â”‚
â”‚    Content-Type: application/json                                     â”‚
â”‚                                                                          â”‚
â”‚  Body:                                                                 â”‚
â”‚  {                                                                     â”‚
â”‚    "success": true,                                                    â”‚
â”‚    "data": {                                                           â”‚
â”‚      "id": "rental-456",                                              â”‚
â”‚      "clientId": "client-123",                                        â”‚
â”‚      "startDate": "2026-02-01T00:00:00Z",                            â”‚
â”‚      "endDate": "2026-02-05T00:00:00Z",                              â”‚
â”‚      "totalPrice": 500,                                               â”‚
â”‚      "discountPercentage": 0,                                         â”‚
â”‚      "status": "PENDING",                                             â”‚
â”‚      "paymentStatus": "PENDING",                                      â”‚
â”‚      "notes": "Notas do aluguel",                                    â”‚
â”‚      "createdAt": "2026-01-15T10:00:00Z",                            â”‚
â”‚      "client": {                                                       â”‚
â”‚        "id": "client-123",                                            â”‚
â”‚        "firstName": "JoÃ£o",                                           â”‚
â”‚        "lastName": "Silva",                                           â”‚
â”‚        "email": "joao@example.com"                                    â”‚
â”‚      },                                                                â”‚
â”‚      "equipmentItems": [                                              â”‚
â”‚        {                                                               â”‚
â”‚          "id": "equip-456",                                           â”‚
â”‚          "name": "Tenda 3x3",                                         â”‚
â”‚          "sku": "TENDA-001",                                          â”‚
â”‚          "dailyRate": 50                                              â”‚
â”‚        }                                                               â”‚
â”‚      ]                                                                 â”‚
â”‚    },                                                                  â”‚
â”‚    "meta": {                                                           â”‚
â”‚      "timestamp": "2026-01-15T10:00:00Z",                            â”‚
â”‚      "requestId": "req-123456789"                                     â”‚
â”‚    }                                                                   â”‚
â”‚  }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    âœ… ASYNC BACKGROUND TASKS                            â”‚
â”‚                                                                          â”‚
â”‚  â€¢ Socket.IO event emitted â†’ Real-time sync to other clients         â”‚
â”‚  â€¢ Activity log persisted â†’ Audit trail recorded                     â”‚
â”‚  â€¢ Database transaction committed                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ OperaÃ§Ãµes CRUD com Prisma-Extended

### CREATE

```
User Input â†’ withSafety (validate) â†’ Handler â†’ Prisma.create() 
â†’ Prisma-Extended (log to ActivityLog) â†’ Response
```

**Activity Log Entry:**
```
{
  userId: 'user-123',
  action: 'CREATE',
  changes: {} (empty, first creation)
}
```

### READ (Find)

```
Query â†’ withSafety (rate limit) â†’ Prisma.findMany() 
â†’ Prisma-Extended (add where: { deletedAt: null }) â†’ Response
```

**Note:** Soft-deleted records automatically filtered out.

### UPDATE

```
User Input â†’ withSafety (validate) â†’ Handler â†’ Prisma.update()
â†’ Prisma-Extended (compare old vs new, log changes) â†’ Response
```

**Activity Log Entry:**
```
{
  userId: 'user-123',
  action: 'UPDATE',
  changes: {
    status: { old: 'PENDING', new: 'CONFIRMED' },
    paymentStatus: { old: 'PENDING', new: 'PARTIAL' }
  }
}
```

### DELETE (Soft-Delete)

```
User Input â†’ withSafety (rate limit) â†’ Handler â†’ Prisma.delete()
â†’ Prisma-Extended (convert to: update { deletedAt: now }) â†’ Response
```

**Activity Log Entry:**
```
{
  userId: 'user-123',
  action: 'DELETE',
  changes: {
    deletedAt: { old: null, new: '2026-01-15T10:00:00Z' }
  }
}
```

**Result:** Record marked as deleted, but still exists in database.

---

## ğŸ” ComparaÃ§Ã£o de SeguranÃ§a

### Antes (Without Integration)

```
API Request
    â†“
Handler
    â”œâ”€ No rate limiting
    â”œâ”€ Manual validation needed
    â”œâ”€ Manual error handling
    â”œâ”€ No activity logging
    â””â”€ Hard-delete (data loss)
    
âŒ VulnerÃ¡vel a:
   - DDoS attacks
   - XSS injections
   - Unhandled exceptions
   - Sem audit trail
   - Accidental data loss
```

### Depois (With Integration)

```
API Request
    â†“
withSafety Wrapper
    â”œâ”€ âœ… Rate limiting (10 req/min)
    â”œâ”€ âœ… XSS prevention (DOMPurify)
    â”œâ”€ âœ… Input validation (Zod)
    â””â”€ âœ… Error handling (HTTP semantics)
    â†“
Handler (Business Logic)
    â”œâ”€ âœ… Soft-delete (recover data)
    â””â”€ âœ… Activity logging (audit trail)
    â†“
Prisma-Extended Middleware
    â”œâ”€ âœ… Auto filter deletedAt
    â””â”€ âœ… Auto log to ActivityLog
    
âœ… Protegido contra:
   + DDoS attacks (429 responses)
   + XSS injections (script tags removed)
   + Unhandled exceptions (400/500 responses)
   + Untraced changes (complete audit trail)
   + Data loss (soft-delete with recovery)
```

---

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT APPLICATION                       â”‚
â”‚                  (React / Next.js Frontend)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ HTTP Request
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               NEXT.JS SERVER (Edge/Node)                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ withSafety() HOC Layer                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ Rate Limiting                                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ Input Validation                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ XSS Prevention                                    â”‚ â”‚
â”‚  â”‚  â””â”€ Error Handling                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ API Route Handler                                      â”‚ â”‚
â”‚  â”‚  â””â”€ Business Logic                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Prisma Client Extended                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Soft-Delete Middleware                           â”‚ â”‚
â”‚  â”‚  â””â”€ Activity Logging Middleware                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ SQL Query
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POSTGRESQL DATABASE                            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Rental   â”‚  â”‚  Equipment â”‚  â”‚   ActivityLog      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ id (PK)    â”‚  â”‚ id (PK)    â”‚  â”‚ id (PK)            â”‚   â”‚
â”‚  â”‚ clientId   â”‚  â”‚ name       â”‚  â”‚ userId             â”‚   â”‚
â”‚  â”‚ startDate  â”‚  â”‚ dailyRate  â”‚  â”‚ entityType         â”‚   â”‚
â”‚  â”‚ endDate    â”‚  â”‚ deletedAt  â”‚  â”‚ entityId           â”‚   â”‚
â”‚  â”‚ totalPrice â”‚  â”‚ ...        â”‚  â”‚ action             â”‚   â”‚
â”‚  â”‚ deletedAt  â”‚  â”‚            â”‚  â”‚ changes (JSON)     â”‚   â”‚
â”‚  â”‚ ...        â”‚  â”‚            â”‚  â”‚ ipAddress          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ userAgent          â”‚   â”‚
â”‚                                    â”‚ createdAt          â”‚   â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ SQL Result
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            RESPONSE BACK TO CLIENT                          â”‚
â”‚                                                              â”‚
â”‚  HTTP Status: 201 Created                                  â”‚
â”‚  Headers: X-RateLimit-*, X-Request-ID                      â”‚
â”‚  Body: { success, data, meta }                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ JSON Response
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               BROWSER / CLIENT UPDATES UI                   â”‚
â”‚                                                              â”‚
â”‚  - Display new rental in table                              â”‚
â”‚  - Socket.IO listener updates other tabs in real-time      â”‚
â”‚  - Activity log visible in audit section                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Rate Limiting Logic

```
Time Window: 60 seconds (1 minute)
Max Requests: 10 for WRITE, 100 for READ

â”‚â—„â”€â”€â”€â”€â”€â”€â”€ 60 seconds â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚0  Req 1  Req 2  Req 3  ... Req 10  Req 11 â† 429 Too Many
â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ If next request > max        â”‚
â”‚ return 429 + Retry-After     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Store: In-Memory Map
Key: "rate-limit:{ip}"
Value: { count: 10, resetTime: 1673779560000 }

Reset: Automatically when resetTime > now()
```

---

## ğŸ” XSS Prevention Flow

```
User Input: "<script>alert('XSS')</script>Notas"
     â”‚
     â†“
Zod Schema: SafeStringLong
     â”‚
     â†“
Transform: sanitizeString(input)
     â”‚
     â†“
DOMPurify.sanitize(input, { ALLOWED_TAGS: [] })
     â”‚
     â†“
Cleaned Output: "Notas"
     â”‚
     â†“
Saved to DB: { notes: "Notas" }  â† No script tags!
```

---

**Status:** ğŸŸ¢ COMPLETE  
**Date:** 15 January 2026
