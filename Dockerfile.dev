# Development Dockerfile for Next.js 16 - Optimized
# Hot reload with nodemon + Next.js HMR
# syntax=docker/dockerfile:1

FROM node:22-alpine
WORKDIR /app

ENV NEXT_TELEMETRY_DISABLED=1 \
    NODE_ENV=development \
    HOSTNAME=0.0.0.0 \
    PORT=3000 \
    NPM_CONFIG_UPDATE_NOTIFIER=false

# Install essential dependencies and global tools in single layer (include postgresql-client like prod)
RUN apk add --no-cache openssl ca-certificates git postgresql-client && \
    npm install -g nodemon tsx --loglevel=error

# Copy package files and install (for best layer caching)
COPY package.json package-lock.json ./
RUN npm install --legacy-peer-deps --no-audit --no-fund --loglevel=error

# Copy prisma schema before full source (for better caching)
COPY ./prisma ./prisma

# Generate Prisma Client
RUN npx prisma generate

# Copy source code
COPY . .

# Copy scripts folder and make entrypoint executable
RUN chmod +x ./scripts/dev-entrypoint.sh

EXPOSE 3000

ENTRYPOINT ["sh", "./scripts/dev-entrypoint.sh"]
CMD ["npm", "run", "dev"]
